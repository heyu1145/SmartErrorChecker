class OfficialSettings {
    constructor(pluginInstance) {
        this.plugin = pluginInstance;
        this.settings = null;
    }

    // æ³¨å†Œå®˜æ–¹è®¾ç½®
    register() {
        if (typeof acode !== 'undefined' && acode.definePluginOptions) {
            acode.definePluginOptions('com.smarterrorchecker.smarterrorchecker', {
                data: this.getSettingsSchema(),
                onsave: (data) => this.onSettingsSave(data)
            });
            console.log('âœ… å®˜æ–¹è®¾ç½®å·²æ³¨å†Œ');
        } else {
            console.warn('âš ï¸ å®˜æ–¹è®¾ç½®APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨è®¾ç½®é¢æ¿');
        }
    }

    // è·å–è®¾ç½®æ¶æ„
    getSettingsSchema() {
        return [
            {
                key: 'enabled',
                type: 'checkbox',
                title: 'å¯ç”¨æ™ºèƒ½é”™è¯¯æ£€æŸ¥',
                description: 'å¯ç”¨æˆ–ç¦ç”¨æ•´ä¸ªé”™è¯¯æ£€æŸ¥åŠŸèƒ½',
                value: this.plugin.settings.enabled
            },
            {
                key: 'realtimeChecking',
                type: 'checkbox',
                title: 'å®æ—¶æ£€æŸ¥',
                description: 'åœ¨è¾“å…¥æ—¶è‡ªåŠ¨æ£€æŸ¥ä»£ç é”™è¯¯',
                value: this.plugin.settings.realtimeChecking
            },
            {
                key: 'useAPI',
                type: 'checkbox',
                title: 'ä½¿ç”¨APIæ£€æŸ¥',
                description: 'ä½¿ç”¨åœ¨çº¿APIè¿›è¡Œæ›´å‡†ç¡®çš„ä»£ç æ£€æŸ¥',
                value: this.plugin.settings.useAPI
            },
            {
                key: 'fallbackToLocal',
                type: 'checkbox',
                title: 'APIå¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°æ£€æŸ¥',
                description: 'å½“APIä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°æ£€æŸ¥å™¨',
                value: this.plugin.settings.fallbackToLocal
            },
            {
                type: 'section',
                title: 'æ˜¾ç¤ºè®¾ç½®'
            },
            {
                key: 'showAnnotations',
                type: 'checkbox',
                title: 'æ˜¾ç¤ºä»£ç æ³¨è§£',
                description: 'åœ¨ä»£ç æ—è¾¹æ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Šä¿¡æ¯',
                value: this.plugin.settings.showAnnotations
            },
            {
                key: 'showGutterMarkers',
                type: 'checkbox',
                title: 'æ˜¾ç¤ºè¡Œå·æ ‡è®°',
                description: 'åœ¨è¡Œå·åŒºåŸŸæ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Šå›¾æ ‡',
                value: this.plugin.settings.showGutterMarkers
            },
            {
                key: 'severityLevel',
                type: 'select',
                title: 'æ˜¾ç¤ºçº§åˆ«',
                description: 'æ§åˆ¶æ˜¾ç¤ºçš„é”™è¯¯ä¸¥é‡ç¨‹åº¦',
                value: this.plugin.settings.severityLevel,
                options: [
                    { value: 'error', text: 'ä»…é”™è¯¯' },
                    { value: 'warning', text: 'é”™è¯¯å’Œè­¦å‘Š' },
                    { value: 'info', text: 'å…¨éƒ¨ä¿¡æ¯' }
                ]
            },
            {
                type: 'section',
                title: 'é«˜çº§è®¾ç½®'
            },
            {
                key: 'timeout',
                type: 'number',
                title: 'APIè¶…æ—¶æ—¶é—´(æ¯«ç§’)',
                description: 'APIè¯·æ±‚çš„è¶…æ—¶æ—¶é—´',
                value: this.plugin.settings.timeout,
                min: 1000,
                max: 30000
            },
            {
                key: 'checkDelay',
                type: 'number',
                title: 'æ£€æŸ¥å»¶è¿Ÿ(æ¯«ç§’)',
                description: 'è¾“å…¥åå¼€å§‹æ£€æŸ¥çš„å»¶è¿Ÿæ—¶é—´',
                value: this.plugin.settings.checkDelay || 1500,
                min: 500,
                max: 5000
            },
            {
                type: 'section',
                title: 'APIè®¾ç½®'
            },
            {
                key: 'customEndpoints',
                type: 'object',
                title: 'è‡ªå®šä¹‰APIç«¯ç‚¹',
                description: 'ä¸ºä¸åŒè¯­è¨€è®¾ç½®è‡ªå®šä¹‰APIç«¯ç‚¹',
                value: this.plugin.settings.customEndpoints || {},
                properties: {
                    javascript: {
                        type: 'string',
                        title: 'JavaScript API',
                        value: this.plugin.settings.apiEndpoints?.javascript || ''
                    },
                    typescript: {
                        type: 'string',
                        title: 'TypeScript API',
                        value: this.plugin.settings.apiEndpoints?.typescript || ''
                    },
                    python: {
                        type: 'string',
                        title: 'Python API',
                        value: this.plugin.settings.apiEndpoints?.python || ''
                    }
                }
            }
        ];
    }

    // è®¾ç½®ä¿å­˜å›è°ƒ
    onSettingsSave(data) {
        console.log('ğŸ’¾ ä¿å­˜è®¾ç½®:', data);
        
        // æ›´æ–°æ’ä»¶è®¾ç½®
        this.plugin.settings = {
            ...this.plugin.settings,
            ...data
        };

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.plugin.configManager.saveSettings(this.plugin.settings);

        // åº”ç”¨æ–°è®¾ç½®
        this.plugin.applySettings();

        this.plugin.showNotification('è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨');
    }

    // æ‰“å¼€å®˜æ–¹è®¾ç½®é¢æ¿
    open() {
        if (typeof acode !== 'undefined' && acode.exec) {
            acode.exec('openSettings', 'com.smarterrorchecker.smarterrorchecker');
        } else {
            this.plugin.settingsPanel.show();
        }
    }

    // æ£€æŸ¥æ˜¯å¦æ”¯æŒå®˜æ–¹è®¾ç½®
    isSupported() {
        return typeof acode !== 'undefined' && acode.definePluginOptions;
    }
}

if (typeof window != 'undefined') {
    window.OfficialSettings = OfficialSettings;
}