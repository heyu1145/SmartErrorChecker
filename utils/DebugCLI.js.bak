class DebugCLI {
    constructor(pluginInstance) {
        this.plugin = pluginInstance;
        this.commands = new Map();
        this.lastCheckResult = null;
        this.commandHistory = [];
        this.maxHistorySize = 50;
        
        this.setupCommands();
        console.log('âœ… DebugCLI åˆå§‹åŒ–å®Œæˆ');
    }

    setupCommands() {
        // åŸºç¡€ä¿¡æ¯å‘½ä»¤
        this.commands.set('info', {
            description: 'æ˜¾ç¤ºæ’ä»¶ä¿¡æ¯',
            execute: () => this.showInfo()
        });

        this.commands.set('status', {
            description: 'æ˜¾ç¤ºå½“å‰çŠ¶æ€',
            execute: () => this.showStatus()
        });

        this.commands.set('version', {
            description: 'æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯',
            execute: () => this.showVersion()
        });

        // æ£€æŸ¥ç›¸å…³å‘½ä»¤
        this.commands.set('check', {
            description: 'ç«‹å³æ‰§è¡Œä»£ç æ£€æŸ¥',
            execute: () => this.forceCheck()
        });

        this.commands.set('analyze', {
            description: 'åˆ†æå½“å‰æ–‡ä»¶çš„ä»£ç é—®é¢˜',
            execute: () => this.analyzeCurrentFile()
        });

        this.commands.set('test', {
            description: 'è¿è¡Œæµ‹è¯•ç”¨ä¾‹',
            execute: () => this.runTestCases()
        });

        // é”™è¯¯ä¿¡æ¯å‘½ä»¤
        this.commands.set('errors', {
            description: 'æ˜¾ç¤ºæœ€åä¸€æ¬¡æ£€æŸ¥çš„é”™è¯¯è¯¦æƒ…',
            execute: () => this.showLastErrors()
        });

        this.commands.set('stats', {
            description: 'æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ç»Ÿè®¡',
            execute: () => this.showDetailedStats()
        });

        this.commands.set('export', {
            description: 'å¯¼å‡ºé”™è¯¯æŠ¥å‘Š',
            execute: (args) => this.exportReport(args[0] || 'console')
        });

        // è®¾ç½®ç›¸å…³å‘½ä»¤
        this.commands.set('settings', {
            description: 'æ˜¾ç¤ºå½“å‰è®¾ç½®',
            execute: () => this.showSettings()
        });

        this.commands.set('config', {
            description: 'æ˜¾ç¤ºé…ç½®è¯¦æƒ…',
            execute: () => this.showConfig()
        });

        this.commands.set('toggle', {
            description: 'åˆ‡æ¢å¯ç”¨çŠ¶æ€',
            execute: () => this.toggleEnabled()
        });

        this.commands.set('mode', {
            description: 'åˆ‡æ¢æ£€æŸ¥æ¨¡å¼',
            execute: () => this.toggleMode()
        });

        // è°ƒè¯•å‘½ä»¤
        this.commands.set('debug', {
            description: 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯',
            execute: () => this.showDebugInfo()
        });

        this.commands.set('env', {
            description: 'æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯',
            execute: () => this.showEnvironment()
        });

        this.commands.set('api', {
            description: 'æµ‹è¯•APIè¿æ¥',
            execute: () => this.testAPIConnection()
        });

        this.commands.set('clear', {
            description: 'æ¸…é™¤æ‰€æœ‰æ ‡è®°å’Œæ—¥å¿—',
            execute: () => this.clearAll()
        });

        this.commands.set('reset', {
            description: 'é‡ç½®æ’ä»¶çŠ¶æ€',
            execute: () => this.resetPlugin()
        });

        // ç³»ç»Ÿå‘½ä»¤
        this.commands.set('history', {
            description: 'æ˜¾ç¤ºå‘½ä»¤å†å²',
            execute: () => this.showHistory()
        });

        this.commands.set('commands', {
            description: 'åˆ—å‡ºæ‰€æœ‰å‘½ä»¤',
            execute: () => this.listCommands()
        });

        this.commands.set('help', {
            description: 'æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯',
            execute: () => this.showHelp()
        });
    }

    // æ‰§è¡Œå‘½ä»¤
    execute(command, args = []) {
        // æ·»åŠ åˆ°å†å²
        this.addToHistory(command, args);
        
        if (!this.commands.has(command)) {
            const suggestion = this.findSuggestion(command);
            let response = `âŒ æœªçŸ¥å‘½ä»¤: ${command}`;
            if (suggestion) {
                response += `\nğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³æ‰§è¡Œ: "${suggestion}"?`;
            }
            response += '\nè¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤';
            return response;
        }

        try {
            console.group(`ğŸ”§ CLI å‘½ä»¤: ${command} ${args.join(' ')}`);
            const result = this.commands.get(command).execute(args);
            console.groupEnd();
            return result;
        } catch (error) {
            console.error('âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥:', error);
            return `âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error.message}\nğŸ’¡ é”™è¯¯è¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°`;
        }
    }

    // å­˜å‚¨æ£€æŸ¥ç»“æœ
    storeCheckResult(errors, fileInfo) {
        this.lastCheckResult = {
            errors: errors || [],
            fileInfo: fileInfo || {},
            timestamp: new Date(),
            stats: this.calculateStats(errors)
        };
        
        console.log(`ğŸ“Š å­˜å‚¨æ£€æŸ¥ç»“æœ: ${errors.length} ä¸ªé—®é¢˜`);
    }

    // è®¡ç®—è¯¦ç»†ç»Ÿè®¡
    calculateStats(errors) {
        const stats = {
            total: errors.length,
            error: 0,
            warning: 0,
            info: 0,
            bySource: {},
            byRule: {},
            bySeverity: {
                error: [],
                warning: [],
                info: []
            },
            byLine: {}
        };

        errors.forEach(error => {
            // æŒ‰ä¸¥é‡ç¨‹åº¦ç»Ÿè®¡
            const severity = error.severity || 'info';
            stats[severity] = (stats[severity] || 0) + 1;
            
            // æŒ‰æ¥æºç»Ÿè®¡
            const source = error.source || 'unknown';
            stats.bySource[source] = (stats.bySource[source] || 0) + 1;
            
            // æŒ‰è§„åˆ™ç»Ÿè®¡
            const rule = error.rule || 'unknown';
            stats.byRule[rule] = (stats.byRule[rule] || 0) + 1;
            
            // æŒ‰è¡Œå·ç»Ÿè®¡
            const line = error.line || 0;
            if (!stats.byLine[line]) {
                stats.byLine[line] = [];
            }
            stats.byLine[line].push(error);
            
            // æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
            if (stats.bySeverity[severity]) {
                stats.bySeverity[severity].push(error);
            }
        });

        return stats;
    }

    // å‘½ä»¤å®ç°
    showInfo() {
        const settings = this.plugin.settings;
        const file = editorManager?.activeFile;
        
        const info = `
ğŸ” SmartErrorChecker æ’ä»¶ä¿¡æ¯:

ç‰ˆæœ¬: 1.0.0
çŠ¶æ€: ${settings.enabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}
æ¨¡å¼: ${settings.useAPI ? 'ğŸŒ APIæ¨¡å¼' : 'ğŸ’» æœ¬åœ°æ¨¡å¼'}
å®æ—¶æ£€æŸ¥: ${settings.realtimeChecking ? 'âœ…' : 'âŒ'}
æ˜¾ç¤ºçº§åˆ«: ${settings.severityLevel}

å½“å‰æ–‡ä»¶: ${file?.name || 'æ— '}
æ–‡ä»¶ç±»å‹: ${file ? this.plugin.fileTypeDetector.getFileType(file.name) : 'æœªçŸ¥'}
åˆå§‹åŒ–: ${this.plugin.isInitialized ? 'âœ… å®Œæˆ' : 'ğŸ”„ è¿›è¡Œä¸­'}
        `.trim();

        console.log(info);
        return info;
    }

    showStatus() {
        const file = editorManager?.activeFile;
        const content = editorManager?.editor.getValue() || '';
        const stats = this.getCurrentStats();

        const status = `
ğŸ“Š å½“å‰çŠ¶æ€:

æ–‡ä»¶: ${file?.name || 'æ— '}
ç±»å‹: ${file ? this.plugin.fileTypeDetector.getFileType(file.name) : 'æœªçŸ¥'}
å¤§å°: ${content.length} å­—ç¬¦
è¡Œæ•°: ${content.split('\n').length}
ç¼–ç : ${this.detectEncoding(content)}

æœ€åæ£€æŸ¥: ${this.lastCheckResult ? this.lastCheckResult.timestamp.toLocaleTimeString() : 'ä»æœªæ£€æŸ¥'}
é—®é¢˜ç»Ÿè®¡: ${stats.total} ä¸ª (âŒ${stats.error} âš ï¸${stats.warning} â„¹ï¸${stats.info})

APIçŠ¶æ€: ${this.getAPIStatus()}
å†…å­˜ä½¿ç”¨: ${this.getMemoryUsage()}
        `.trim();

        console.log(status);
        return status;
    }

    showVersion() {
        const versionInfo = `
ğŸ“¦ SmartErrorChecker ç‰ˆæœ¬ä¿¡æ¯:

ä¸»ç‰ˆæœ¬: 1.0.0
Acodeç‰ˆæœ¬: ${this.getAcodeVersion()}
æ„å»ºæ—¶é—´: ${this.getBuildTime()}
æ”¯æŒè¯­è¨€: ${this.getSupportedLanguages()}
CLIç‰ˆæœ¬: 1.0.0
        `.trim();

        console.log(versionInfo);
        return versionInfo;
    }

    forceCheck() {
        if (!this.plugin.settings.enabled) {
            return 'âŒ æ£€æŸ¥å™¨å·²ç¦ç”¨ï¼Œè¯·å…ˆå¯ç”¨\nğŸ’¡ ä½¿ç”¨: toggle å‘½ä»¤å¯ç”¨';
        }

        console.group('ğŸ” æ‰‹åŠ¨è§¦å‘ä»£ç æ£€æŸ¥');
        this.plugin.checkWithSmartService();
        console.groupEnd();

        return 'âœ… å·²è§¦å‘ä»£ç æ£€æŸ¥ï¼Œè¯·æŸ¥çœ‹çŠ¶æ€æ å’Œæ§åˆ¶å°è¾“å‡º';
    }

    analyzeCurrentFile() {
        const file = editorManager?.activeFile;
        if (!file) {
            return 'âŒ æ²¡æœ‰æ´»è·ƒæ–‡ä»¶';
        }

        const fileType = this.plugin.fileTypeDetector.getFileType(file.name);
        const content = editorManager.editor.getValue();
        
        if (!content.trim()) {
            return 'âŒ æ–‡ä»¶å†…å®¹ä¸ºç©º';
        }

        console.group('ğŸ” æ·±åº¦æ–‡ä»¶åˆ†æ');
        
        let errors = [];
        try {
            // ä½¿ç”¨æœ¬åœ°æ£€æŸ¥å™¨è¿›è¡Œåˆ†æ
            if (this.plugin.localLinter && typeof this.plugin.localLinter.lint === 'function') {
                errors = this.plugin.localLinter.lint(content, fileType);
            } else {
                errors = this.basicLint(content, fileType);
            }
        } catch (error) {
            console.error('åˆ†æå¤±è´¥:', error);
            return `âŒ åˆ†æå¤±è´¥: ${error.message}`;
        }

        // å­˜å‚¨ç»“æœ
        this.storeCheckResult(errors, {
            name: file.name,
            type: fileType,
            size: content.length,
            lines: content.split('\n').length,
            analysis: 'deep'
        });

        const stats = this.calculateStats(errors);
        
        let result = `ğŸ“Š æ·±åº¦åˆ†æç»“æœ:\n\n`;
        result += `æ–‡ä»¶: ${file.name}\n`;
        result += `ç±»å‹: ${fileType}\n`;
        result += `å¤§å°: ${content.length} å­—ç¬¦\n`;
        result += `è¡Œæ•°: ${content.split('\n').length}\n`;
        result += `åˆ†ææ—¶é—´: ${new Date().toLocaleTimeString()}\n\n`;

        if (stats.total > 0) {
            result += `ğŸ“ˆ é—®é¢˜åˆ†æ:\n`;
            result += `   æ€»è®¡: ${stats.total} ä¸ªé—®é¢˜\n`;
            result += `   âŒ é”™è¯¯: ${stats.error}\n`;
            result += `   âš ï¸ è­¦å‘Š: ${stats.warning}\n`;
            result += `   â„¹ï¸ ä¿¡æ¯: ${stats.info}\n\n`;

            // é—®é¢˜åˆ†å¸ƒ
            if (Object.keys(stats.bySource).length > 0) {
                result += `ğŸ”§ æ£€æŸ¥æ¥æº:\n`;
                Object.entries(stats.bySource).forEach(([source, count]) => {
                    result += `   ${source}: ${count}\n`;
                });
                result += '\n';
            }

            // æœ€ä¸¥é‡çš„é—®é¢˜
            const topErrors = [...errors]
                .sort((a, b) => {
                    const severityOrder = { error: 3, warning: 2, info: 1 };
                    return (severityOrder[b.severity] || 1) - (severityOrder[a.severity] || 1);
                })
                .slice(0, 3);

            if (topErrors.length > 0) {
                result += `ğŸ¯ æœ€ä¸¥é‡çš„é—®é¢˜:\n`;
                topErrors.forEach((error, index) => {
                    const icon = this.getSeverityIcon(error.severity);
                    result += `   ${index + 1}. ${icon} ç¬¬${error.line + 1}è¡Œ: ${error.message}\n`;
                });
            }
        } else {
            result += 'ğŸ‰ ä»£ç è´¨é‡ä¼˜ç§€ï¼æœªå‘ç°ä»»ä½•é—®é¢˜ã€‚';
        }

        console.groupEnd();
        console.log(result);
        return result;
    }

    showLastErrors() {
        if (!this.lastCheckResult) {
            return 'âŒ æ²¡æœ‰å¯ç”¨çš„æ£€æŸ¥ç»“æœ\nğŸ’¡ ä½¿ç”¨: check æˆ– analyze å‘½ä»¤å…ˆæ‰§è¡Œæ£€æŸ¥';
        }

        const { errors, fileInfo, timestamp, stats } = this.lastCheckResult;
        
        let result = `ğŸ“‹ æ£€æŸ¥ç»“æœ (${timestamp.toLocaleTimeString()})\n\n`;
        result += `æ–‡ä»¶: ${fileInfo.name || 'æœªçŸ¥'}\n`;
        result += `ç±»å‹: ${fileInfo.type || 'æœªçŸ¥'}\n`;
        result += `é—®é¢˜æ€»æ•°: ${stats.total}\n\n`;

        if (errors.length === 0) {
            result += 'ğŸ‰ æ²¡æœ‰å‘ç°é—®é¢˜ï¼';
            console.log(result);
            return result;
        }

        // æŒ‰ä¸¥é‡ç¨‹åº¦å’Œè¡Œå·æ’åº
        const sortedErrors = [...errors].sort((a, b) => {
            const severityOrder = { error: 3, warning: 2, info: 1 };
            const aOrder = severityOrder[a.severity] || 1;
            const bOrder = severityOrder[b.severity] || 1;
            
            if (aOrder !== bOrder) return bOrder - aOrder;
            if (a.line !== b.line) return a.line - b.line;
            return (a.column || 0) - (b.column || 0);
        });

        // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
        result += `ğŸ“ é—®é¢˜è¯¦æƒ…:\n\n`;
        sortedErrors.forEach((error, index) => {
            const icon = this.getSeverityIcon(error.severity);
            const location = `ç¬¬${error.line + 1}è¡Œ${error.column ? `,ç¬¬${error.column + 1}åˆ—` : ''}`;
            
            result += `${icon} ${location}: ${error.message}\n`;
            
            if (error.source) {
                result += `   æ¥æº: ${error.source}\n`;
            }
            if (error.rule) {
                result += `   è§„åˆ™: ${error.rule}\n`;
            }
            
            // æ˜¾ç¤ºä»£ç ç‰‡æ®µ
            const codeSnippet = this.getCodeSnippet(error.line);
            if (codeSnippet) {
                result += `   ä»£ç : ${codeSnippet}\n`;
            }
            
            if (index < sortedErrors.length - 1) {
                result += '\n';
            }
        });

        console.log(result);
        return result;
    }

    showDetailedStats() {
        if (!this.lastCheckResult) {
            return 'âŒ æ²¡æœ‰å¯ç”¨çš„æ£€æŸ¥ç»“æœ';
        }

        const { stats, fileInfo, timestamp } = this.lastCheckResult;
        
        let result = `ğŸ“Š è¯¦ç»†ç»Ÿè®¡åˆ†æ\n\n`;
        result += `æ–‡ä»¶: ${fileInfo.name || 'æœªçŸ¥'}\n`;
        result += `æ£€æŸ¥æ—¶é—´: ${timestamp.toLocaleString()}\n`;
        result += `åˆ†ææ—¶é•¿: ${Date.now() - timestamp.getTime()}ms\n\n`;

        // æ€»ä½“ç»Ÿè®¡
        result += `ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:\n`;
        result += `   æ€»è®¡: ${stats.total} ä¸ªé—®é¢˜\n`;
        result += `   âŒ é”™è¯¯: ${stats.error} (${this.getPercentage(stats.error, stats.total)})\n`;
        result += `   âš ï¸ è­¦å‘Š: ${stats.warning} (${this.getPercentage(stats.warning, stats.total)})\n`;
        result += `   â„¹ï¸ ä¿¡æ¯: ${stats.info} (${this.getPercentage(stats.info, stats.total)})\n\n`;

        // æŒ‰æ¥æºç»Ÿè®¡
        if (Object.keys(stats.bySource).length > 0) {
            result += `ğŸ”§ æ£€æŸ¥æ¥æºåˆ†å¸ƒ:\n`;
            Object.entries(stats.bySource)
                .sort((a, b) => b[1] - a[1])
                .forEach(([source, count]) => {
                    result += `   ${source.padEnd(15)}: ${count.toString().padEnd(3)} (${this.getPercentage(count, stats.total)})\n`;
                });
            result += '\n';
        }

        // æŒ‰è§„åˆ™ç»Ÿè®¡
        if (Object.keys(stats.byRule).length > 0) {
            result += `ğŸ“ è§„åˆ™ç»Ÿè®¡ (å‰10):\n`;
            const sortedRules = Object.entries(stats.byRule)
                .filter(([rule]) => rule !== 'unknown')
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            sortedRules.forEach(([rule, count]) => {
                result += `   ${rule.padEnd(20)}: ${count}\n`;
            });
            result += '\n';
        }

        // æŒ‰è¡Œå·ç»Ÿè®¡
        if (Object.keys(stats.byLine).length > 0) {
            const problemLines = Object.keys(stats.byLine)
                .map(line => parseInt(line))
                .sort((a, b) => b - a)
                .slice(0, 5);

            if (problemLines.length > 0) {
                result += `ğŸ” é—®é¢˜é›†ä¸­è¡Œå·:\n`;
                problemLines.forEach(line => {
                    const lineErrors = stats.byLine[line];
                    result += `   ç¬¬${line + 1}è¡Œ: ${lineErrors.length} ä¸ªé—®é¢˜\n`;
                });
            }
        }

        console.log(result);
        return result;
    }

    showSettings() {
        const settings = this.plugin.settings;
        const settingInfo = `
âš™ï¸ å½“å‰è®¾ç½®:

ğŸ”§ åŸºæœ¬è®¾ç½®:
   å¯ç”¨æ£€æŸ¥: ${settings.enabled ? 'âœ…' : 'âŒ'}
   å®æ—¶æ£€æŸ¥: ${settings.realtimeChecking ? 'âœ…' : 'âŒ'}
   ä½¿ç”¨API: ${settings.useAPI ? 'âœ…' : 'âŒ'}
   å›é€€æœ¬åœ°: ${settings.fallbackToLocal ? 'âœ…' : 'âŒ'}

ğŸ‘ï¸ æ˜¾ç¤ºè®¾ç½®:
   æ˜¾ç¤ºçº§åˆ«: ${settings.severityLevel}
   æ˜¾ç¤ºæ³¨è§£: ${settings.showAnnotations ? 'âœ…' : 'âŒ'}
   è¡Œå·æ ‡è®°: ${settings.showGutterMarkers ? 'âœ…' : 'âŒ'}

â±ï¸ æ€§èƒ½è®¾ç½®:
   è¶…æ—¶æ—¶é—´: ${settings.timeout}ms
   æ£€æŸ¥å»¶è¿Ÿ: ${settings.checkDelay}ms
        `.trim();

        console.log(settingInfo);
        return settingInfo;
    }

    showConfig() {
        const config = this.plugin.configManager.getSettings();
        const configInfo = `
ğŸ”§ é…ç½®è¯¦æƒ…:

é»˜è®¤é…ç½®: ${JSON.stringify(this.plugin.configManager.defaultConfig, null, 2)}
å½“å‰é…ç½®: ${JSON.stringify(config, null, 2)}
å­˜å‚¨çŠ¶æ€: ${localStorage.getItem('acode_smart_error_checker_settings') ? 'âœ… å·²ä¿å­˜' : 'âŒ æœªä¿å­˜'}
        `.trim();

        console.log(configInfo);
        return configInfo;
    }

    // ... å…¶ä»–å‘½ä»¤å®ç°ï¼ˆtoggle, mode, debug, env, api, clear, reset, history, commands, helpï¼‰...

    // è¾…åŠ©æ–¹æ³•
    getSeverityIcon(severity) {
        const icons = { error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
        return icons[severity] || 'ğŸ“';
    }

    getCodeSnippet(lineNumber) {
        try {
            const content = editorManager?.editor.getValue();
            if (!content) return null;
            
            const lines = content.split('\n');
            if (lineNumber >= 0 && lineNumber < lines.length) {
                const snippet = lines[lineNumber].trim();
                return snippet.length > 50 ? snippet.substring(0, 47) + '...' : snippet;
            }
        } catch (error) {
            // å¿½ç•¥é”™è¯¯
        }
        return null;
    }

    getPercentage(part, total) {
        if (total === 0) return '0%';
        return ((part / total) * 100).toFixed(1) + '%';
    }

    detectEncoding(content) {
        // ç®€å•çš„ç¼–ç æ£€æµ‹
        if (content.includes('\\u')) return 'Unicode';
        if (content.match(/[^\x00-\x7F]/)) return 'UTF-8';
        return 'ASCII';
    }

    getAPIStatus() {
        if (!this.plugin.apiManager) return 'æœªçŸ¥';
        const status = this.plugin.apiManager.apiStatus;
        const available = Object.values(status).filter(Boolean).length;
        const total = Object.keys(status).length;
        return `${available}/${total} å¯ç”¨`;
    }

    getMemoryUsage() {
        if (typeof process !== 'undefined' && process.memoryUsage) {
            const usage = process.memoryUsage();
            return Math.round(usage.heapUsed / 1024 / 1024) + ' MB';
        }
        return 'N/A';
    }

    getAcodeVersion() {
        return typeof acode !== 'undefined' ? 'å¯ç”¨' : 'æœªçŸ¥';
    }

    getBuildTime() {
        return new Date().toLocaleDateString();
    }

    getSupportedLanguages() {
        const detector = this.plugin.fileTypeDetector;
        if (detector && detector.typeMap) {
            return Object.keys(detector.typeMap).length;
        }
        return 'æœªçŸ¥';
    }

    addToHistory(command, args) {
        this.commandHistory.push({
            command,
            args,
            timestamp: new Date()
        });
        
        // é™åˆ¶å†å²è®°å½•å¤§å°
        if (this.commandHistory.length > this.maxHistorySize) {
            this.commandHistory.shift();
        }
    }

    findSuggestion(input) {
        const commands = Array.from(this.commands.keys());
        return commands.find(cmd => 
            cmd.startsWith(input) || 
            cmd.includes(input) ||
            this.levenshteinDistance(cmd, input) <= 2
        );
    }

    levenshteinDistance(a, b) {
        // ç®€å•çš„å­—ç¬¦ä¸²ç›¸ä¼¼åº¦è®¡ç®—
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) {
            matrix[i] = [i];
        }
        for (let j = 0; j <= a.length; j++) {
            matrix[0][j] = j;
        }

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }

        return matrix[b.length][a.length];
    }

    getCurrentStats() {
        if (this.lastCheckResult) {
            return this.lastCheckResult.stats;
        }
        return { total: 0, error: 0, warning: 0, info: 0 };
    }

    basicLint(code, fileType) {
        // ç®€åŒ–çš„æ£€æŸ¥é€»è¾‘ï¼Œç”¨äºå¤‡ç”¨
        const errors = [];
        const lines = code.split('\n');
        
        lines.forEach((line, lineNumber) => {
            if (fileType === 'javascript' || fileType === 'typescript') {
                if (line.includes(' == ') && !line.includes(' === ')) {
                    errors.push({
                        line: lineNumber,
                        column: line.indexOf(' == '),
                        message: 'å»ºè®®ä½¿ç”¨ === è€Œä¸æ˜¯ ==',
                        severity: 'warning',
                        source: 'Debug Checker',
                        rule: 'eqeqeq'
                    });
                }
                
                // æ£€æŸ¥æœªé—­åˆæ‹¬å·
                const openParen = (line.match(/\(/g) || []).length;
                const closeParen = (line.match(/\)/g) || []).length;
                if (openParen > closeParen) {
                    errors.push({
                        line: lineNumber,
                        column: line.lastIndexOf('('),
                        message: 'å¯èƒ½ç¼ºå°‘é—­åˆæ‹¬å·',
                        severity: 'warning',
                        source: 'Debug Checker',
                        rule: 'paren-match'
                    });
                }
            }
        });
        
        return errors;
    }
}

// ç¡®ä¿ç±»åœ¨å…¨å±€å¯ç”¨
if (typeof window !== 'undefined') {
    window.DebugCLI = DebugCLI;
}