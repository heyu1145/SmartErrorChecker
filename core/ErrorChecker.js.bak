class SmartErrorChecker {
    constructor(statusBar, settingsBtn) {
        // åˆå§‹åŒ–ç®¡ç†å™¨
        this.configManager = new ConfigManager();
        this.apiManager = new APIManager();
        this.localLinter = new LocalLinter();
        this.fileTypeDetector = new FileTypeDetector();
        this.errorFilter = new ErrorFilter();
        
        // UIç»„ä»¶
        this.statusBar = new StatusBar(statusBar);
        this.settingsPanel = new SettingsPanel(this, settingsBtn);
        this.annotations = new Annotations(this);
        this.officialSettings = new OfficialSettings(this);
        
        // è°ƒè¯•å·¥å…·
        this.debugCLI = new DebugCLI(this);
        
        // çŠ¶æ€ç®¡ç†
        this.settings = this.configManager.getSettings();
        this.checkTimeout = null;
        this.errorMarkers = [];
        this.currentAnnotations = [];
        this.apiStatus = {};
        this.isInitialized = false;
        
        this.init();
    }
    
    async init() {
        try {
            console.log('ğŸ¯ SmartErrorChecker æ ¸å¿ƒåˆå§‹åŒ–å¼€å§‹');
            
            // æ›´æ–°UIæ˜¾ç¤º
            this.statusBar.update({ checking: true });
            
            // æµ‹è¯•APIè¿æ¥
            await this.apiManager.testConnections();
            console.log('âœ… APIè¿æ¥æµ‹è¯•å®Œæˆ');
            
            // è®¾ç½®é”™è¯¯æ£€æŸ¥
            this.setupErrorChecking();
            
            // æ³¨å†Œå®˜æ–¹è®¾ç½®
            this.officialSettings.register();
            
            // è®¾ç½®å…¨å±€CLI
            this.setupGlobalCLI();
            
            // æ›´æ–°UIçŠ¶æ€
            this.updateUI();
            
            this.isInitialized = true;
            console.log('âœ… SmartErrorChecker æ ¸å¿ƒåˆå§‹åŒ–å®Œæˆ');
            
            // å»¶è¿Ÿæ‰§è¡Œé¦–æ¬¡æ£€æŸ¥
            if (this.settings.enabled) {
                setTimeout(() => {
                    this.checkWithSmartService();
                }, 2000);
            }
            
        } catch (error) {
            console.error('âŒ æ ¸å¿ƒåˆå§‹åŒ–å¤±è´¥:', error);
            this.statusBar.update({ 
                errors: [],
                message: 'åˆå§‹åŒ–å¤±è´¥'
            });
            this.showNotification('æ£€æŸ¥å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        }
    }
    
    setupErrorChecking() {
        if (this.checkTimeout) {
            clearTimeout(this.checkTimeout);
        }
        
        const checkDelay = this.settings.checkDelay || 1500;
        
        if (this.settings.enabled && this.settings.realtimeChecking) {
            try {
                if (editorManager && editorManager.editor) {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                    editorManager.editor.off('change');
                    
                    // æ·»åŠ æ–°çš„å˜åŒ–ç›‘å¬
                    editorManager.editor.on('change', () => {
                        clearTimeout(this.checkTimeout);
                        this.checkTimeout = setTimeout(() => {
                            this.checkWithSmartService();
                        }, checkDelay);
                    });
                    
                    console.log('âœ… å®æ—¶æ£€æŸ¥ç›‘å¬å™¨è®¾ç½®æˆåŠŸ');
                }
            } catch (error) {
                console.warn('âŒ è®¾ç½®å˜åŒ–ç›‘å¬å¤±è´¥:', error);
            }
        }
    }
    
    async checkWithSmartService() {
        if (!this.settings.enabled || !this.isInitialized) {
            return;
        }
        
        try {
            const file = editorManager?.activeFile;
            if (!file) {
                this.annotations.clearAll();
                this.statusBar.update({ errors: [] });
                return;
            }
            
            const fileType = this.fileTypeDetector.getFileType(file.name);
            const content = editorManager.editor.getValue();
            
            // ç©ºæ–‡ä»¶æ£€æŸ¥
            if (!content.trim()) {
                this.annotations.clearAll();
                this.statusBar.update({ errors: [] });
                return;
            }
            
            // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
            if (fileType === 'unknown') {
                this.statusBar.update({ 
                    errors: [],
                    message: 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'
                });
                return;
            }
            
            console.log(`ğŸ” å¼€å§‹æ£€æŸ¥ ${fileType} æ–‡ä»¶: ${file.name}`);
            this.statusBar.update({ checking: true, fileType });
            
            let errors = [];
            
            // é€‰æ‹©æ£€æŸ¥æ–¹å¼
            if (this.settings.useAPI && this.apiManager.isAvailable(fileType)) {
                try {
                    console.log(`ğŸŒ ä½¿ç”¨APIæ£€æŸ¥ ${fileType} ä»£ç `);
                    errors = await this.apiManager.lintWithAPI(content, fileType);
                } catch (apiError) {
                    console.warn(`APIæ£€æŸ¥å¤±è´¥: ${apiError.message}`);
                    if (this.settings.fallbackToLocal) {
                        console.log('ğŸ”„ å›é€€åˆ°æœ¬åœ°æ£€æŸ¥');
                        errors = await this.localLinter.lint(content, fileType);
                    }
                }
            } else {
                console.log(`ğŸ’» ä½¿ç”¨æœ¬åœ°æ£€æŸ¥ ${fileType} ä»£ç `);
                errors = await this.localLinter.lint(content, fileType);
            }
            
            // è¿‡æ»¤é”™è¯¯å¹¶æ˜¾ç¤º
            const filteredErrors = this.errorFilter.filter(errors, this.settings.severityLevel);
            this.annotations.display(filteredErrors);
            this.statusBar.update({ errors: filteredErrors });
            
            // å­˜å‚¨ç»“æœåˆ°CLI
            if (this.debugCLI) {
                this.debugCLI.storeCheckResult(filteredErrors, {
                    name: file.name,
                    type: fileType,
                    size: content.length,
                    lines: content.split('\n').length
                });
            }
            
            console.log(`âœ… æ£€æŸ¥å®Œæˆ: ${filteredErrors.length} ä¸ªé—®é¢˜`);
            
        } catch (error) {
            console.error('âŒ ä»£ç æ£€æŸ¥å¤±è´¥:', error);
            this.statusBar.update({ errors: [] });
            this.showNotification('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            
            // åœ¨CLIä¸­è®°å½•é”™è¯¯
            if (this.debugCLI) {
                this.debugCLI.storeCheckResult([], {
                    name: editorManager?.activeFile?.name || 'unknown',
                    type: 'error',
                    error: error.message
                });
            }
        }
    }
    
    setupGlobalCLI() {
        // æš´éœ²è°ƒè¯•æ¥å£åˆ°å…¨å±€
        window.SMART_ERROR_CLI = this.debugCLI;
        window.smartErrorCheckerCLI = this.debugCLI;
        
        console.log('âœ… è°ƒè¯•å‘½ä»¤è¡Œå·²å¯ç”¨');
        console.log('ğŸ’¡ ä½¿ç”¨: SMART_ERROR_CLI.execute("help") æŸ¥çœ‹å‘½ä»¤');
    }
    
    // è®¾ç½®ç›¸å…³æ–¹æ³•
    toggleEnabled() {
        this.settings.enabled = !this.settings.enabled;
        this.configManager.saveSettings(this.settings);
        this.applySettings();
        
        const message = this.settings.enabled ? 'æ£€æŸ¥å™¨å·²å¯ç”¨' : 'æ£€æŸ¥å™¨å·²ç¦ç”¨';
        this.showNotification(message);
    }
    
    toggleAPIMode() {
        this.settings.useAPI = !this.settings.useAPI;
        this.configManager.saveSettings(this.settings);
        this.applySettings();
        
        const message = this.settings.useAPI ? 'å·²åˆ‡æ¢åˆ°APIæ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼';
        this.showNotification(message);
        
        // é‡æ–°æ£€æŸ¥ä»¥åº”ç”¨æ–°æ¨¡å¼
        setTimeout(() => this.checkWithSmartService(), 500);
    }
    
    applySettings() {
        this.updateUI();
        this.setupErrorChecking();
        
        if (this.settings.enabled) {
            setTimeout(() => this.checkWithSmartService(), 500);
        } else {
            this.annotations.clearAll();
            this.statusBar.update({ errors: [] });
        }
    }
    
    updateUI() {
        this.statusBar.updateVisibility(this.settings.enabled);
        this.settingsPanel.updateVisibility(this.settings.enabled);
    }
    
    // å·¥å…·æ–¹æ³•
    showNotification(message, type = 'info') {
        console.log(`ğŸ”” ${message}`);
        if (window.toast) {
            window.toast(message, 2000);
        }
        
        // å¤‡ç”¨é€šçŸ¥æ–¹å¼
        if (type === 'error') {
            this.statusBar.update({ message: `âŒ ${message}` });
        }
    }
    
    openSettings() {
        if (this.officialSettings.isSupported()) {
            this.officialSettings.open();
        } else {
            this.settingsPanel.show();
        }
    }
    
    // è°ƒè¯•æ–¹æ³•
    debug() {
        return this.debugCLI ? this.debugCLI.execute('info') : 'è°ƒè¯•CLIä¸å¯ç”¨';
    }
    
    // æ¸…ç†æ–¹æ³•
    destroy() {
        console.log('ğŸ”§ SmartErrorChecker å¼€å§‹æ¸…ç†...');
        
        // æ¸…ç†æ£€æŸ¥å®šæ—¶å™¨
        if (this.checkTimeout) {
            clearTimeout(this.checkTimeout);
            this.checkTimeout = null;
        }
        
        // æ¸…ç†æ³¨è§£å’Œæ ‡è®°
        this.annotations.clearAll();
        
        // æ¸…ç†UIç»„ä»¶
        this.statusBar.destroy();
        this.settingsPanel.destroy();
        
        // æ¸…ç†å…¨å±€å¼•ç”¨
        window.SMART_ERROR_CLI = null;
        window.smartErrorCheckerCLI = null;
        
        console.log('âœ… SmartErrorChecker æ¸…ç†å®Œæˆ');
    }
    
    // å¿«é€Ÿæ“ä½œèœå•
    showQuickActions() {
        const actions = [
            '1. é‡æ–°æ£€æŸ¥ä»£ç ',
            '2. ' + (this.settings.enabled ? 'ç¦ç”¨æ£€æŸ¥å™¨' : 'å¯ç”¨æ£€æŸ¥å™¨'),
            '3. ' + (this.settings.useAPI ? 'åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼' : 'åˆ‡æ¢åˆ°APIæ¨¡å¼'),
            '4. æ‰“å¼€è®¾ç½®',
            '5. æµ‹è¯•APIè¿æ¥',
            '6. æ¸…é™¤æ‰€æœ‰æ ‡è®°',
            '7. è°ƒè¯•ä¿¡æ¯'
        ].join('\n');
        
        const choice = prompt(`ğŸ”§ SmartErrorChecker\n\n${actions}\n\né€‰æ‹©æ“ä½œ:`, '1');
        
        switch(choice) {
            case '1': this.checkWithSmartService(); break;
            case '2': this.toggleEnabled(); break;
            case '3': this.toggleAPIMode(); break;
            case '4': this.openSettings(); break;
            case '5': this.apiManager.testConnections().then(() => {
                this.showNotification('APIè¿æ¥æµ‹è¯•å®Œæˆ');
            }); break;
            case '6': this.annotations.clearAll(); break;
            case '7': this.debug(); break;
        }
    }
}
if (typeof window != 'undefined') {
    window.SmartErrorChecker = SmartErrorChecker;
}